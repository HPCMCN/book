# 1. IP数据报

对于 IP 协议，传输的消息单元被称为数据报（datagram）或数据包（packet）

数据传输的以太网帧大致如下:


![图片描述](02-%E8%B7%AF%E7%94%B1%E5%99%A8.assets/0.02050174884171141.png)

# 2. 路由器

## 2.1 作用

路由器就是一个具有多个网络接口（对应多个网卡）的机器，每个接口连接到一个网络。它的作用是把接收到的数据包（packet）分发到不同的网络。

1. 路由器是一种具有多个网络接口的机器
2. 路由器的每个接口都连接到一个网络，因此路由器将多个网络链接在一起,
3. 任何具有多个网络接口的机器都可以扮演路由器的角色，甚至是几十年前的一台电脑
4. 路由器不同于普通的机器，因为它可以分发（起到中继（relay）的作用）不是发给自己的数据包
5. 路由器通过路由表来分发数据包
6. 路由表指明了要使用哪个网关（Gateway）来加入一个网络


## 2.2 路由表

路由表的原理是在表的一列中记录要加入的网络的列表，另一列则记录必须向其发送数据报以加入这些网络的路由器的列表。这些路由器也被称为网关（Gateway），因为它们充当两个网络之间的“关口”。

路由表编写有一下流程:
1. 指明本机连接的网络
2. 写出默认路由
3. 写出本机无法通过前面两个步骤加入的所有其他网络


## 2.3 路由表编写

![图片描述](02-%E8%B7%AF%E7%94%B1%E5%99%A8.assets/0.42004456262882073.png)

#### 1. 路由器1

* **指明本机连接的网络**

|连接的网络|网关IP|
|---|---|
|192.168.0.0/24|192.168.0.254|
|192.168.1.0/24|192.168.1.254|

* **默认路由**

|连接的网络|网关IP|
|---|---|
|192.168.0.0/24|192.168.0.254|
|192.168.1.0/24|192.168.1.254|
|default|192.168.1.253|


* **写出本机无法通过前面两个步骤加入的所有其他网络**


|连接的网络|网关IP|
|---|---|
|192.168.0.0/24|192.168.0.254|
|192.168.1.0/24|192.168.1.254|
|default|192.168.1.253|
|10.0.0.0/24|192.168.0.253|


#### 2. 路由器2

* **指明本机连接的网络**


|连接的网络|网关IP|
|---|---|
|10.0.0.0/24|10.0.0.254|
|192.168.0.0/24|192.168.0.253|

* **默认路由**


|连接的网络|网关IP|
|---|---|
|192.168.0.0/24|192.168.0.254|
|192.168.1.0/24|192.168.1.254|
|default|192.168.0.154|

* **写出本机无法通过前面两个步骤加入的所有其他网络**

 由于其他网络都可以通过默认网关连接到, 所以不用再重复添加


#### 3. 主机10.0.1.2

|连接的网络|网关IP|
|---|---|
|10.0.1.0/24|10.0.1.2|
|default|10.0.1.254|
|192.168.1.0|10.0.1.253|
|192.168.0.0|10.0.1.253|
|10.0.0.0|10.0.1.253|

#### 4. 主机10.0.0.1

|连接的网络|网关IP|
|---|---|
|10.0.0.0/24|10.0.0.1|
|default|10.0.0.254|

# 3. 设置路由表

## 3.1 命令

```python
route print  # windows
route -n  # linux
route add -net 192.168.0.0 netmask 0.0.0.0 gw 192.168.0.254  # 添加网关
route del -net 192.168.0.0 netmask 0.0.0.0 gw 192.168.0.254  # 删除网关

在链路上(On-link)表示那一列的IP都一样
```

## 3.2 利用3台主机构建路由转发

首先关闭三台linux的防火墙`iptables -F`

使用虚拟机, 将网卡设置为桥接模式, 构建虚拟ip网段设置为10.0.0.0/24, 需要构建的两个网段为192.168.0.0/24, 192.168.1.0/24

### 1. linux1(192.168.0.1)

* 查看网卡情况


```python
ifconfig
找到网卡名称, 创建虚拟网卡,并配置IP信息
配置虚拟网卡: ifconfig eth0:1 192.168.0.1 netmask 255.255.255.0
配置路由表: route add -net 0.0.0.0 gw 192.168.0.254 netmask 0.0.0.0
```

### 2. linux2(路由)

```python
配置虚拟网卡: 
ifconfig eth0:1 192.168.0.254 netmask 255.255.255.0
ifconfig eth0:1 192.168.1.254 netmask 255.255.255.0                            
配置路由:
不用怎么配置, 如果需要连接外网则需要配置
激活路由功能:(0表示不转发, 1表示转发数据包)
echo 1 > /proc/sys/net/ipv4/ip_forward
```

### 3. linux1(192.168.1.1)
* 查看网卡情况


```python
ifconfig
找到网卡名称, 创建虚拟网卡,并配置IP信息
配置虚拟网卡: ifconfig eth0:1 192.168.1.1 netmask 255.255.255.0
配置路由表: route add -net 0.0.0.0 gw 192.168.1.254 netmask 0.0.0.0
```

如果能从linux1 `ping 192.168.1.1`成功, 并从linux3`ping 192.168.0.1`成功则配置完成








