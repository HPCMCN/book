# 1. Kube-proxy

默认代理使用iptables, 需要修改为ipvs.

* 查看当前代理

  ```shell
  curl 127.0.0.1:10249/proxyMode
  ```

* 修改代理模式

  ```shell
  kubectl edit cm kube-proxy -n kube-system
  # 搜索mode, 默认是空, 就是iptables, 改成ipvs
  ```

* 更新生效

  ```shell
  kubectl patch daemonset kube-proxy -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"date\":\"`date +'%s'`\"}}}}}" -n kube-system
  ```

* 校验

  ```shell
  kubectl get pod -n kube-system
  # 此时pod会重启, 等重启完成后, 模式将会被修改
  curl 127.0.0.1:10249/proxyMode
  ```

  

# 2. 其他集群配置变更

配置目录: /etc/kubernetes/manifests/

流程如下:

* 直接修改配置, 然后保存退出

* 集群检测变动后, 自动重启pod生效, 或者执行`systemctl restart kubelet`即可

# 3. 更新证书

## 3.1 自动续期

推荐一年更新一次, 如果集群升级的话, 会自动续期1年

* 查看证书有效期

  ```shell
  kubeadm certs check-expiration
  ```

* 备份证书

  ```shell
  cp -rp /etc/kubernetes/kpi /opt/kpi_bak
  ```

* 证书续期1年

  ```shell
  # 此命令只能续期一年
  kubeadm certs renew all
  # 此操作会更新 配置文件
  # 可以查看
  ll /etc/kubernetes/pki/
  ```

* 重启生效

  ```shell
  # 全集群重启
  systemctl restart kubelet
  ```

* 检验更新

  ```shell
  kubectl top node -n kube-system
  ```

## 3.2 更新证书99年

* 查看当前版本信息

  ```shell
  kubeadm version
  ```

* 拉取k8s源码

  ```shell
  # 注意这玩意超级大, 建议下载下来, 然后发送到其他master和节点上面去
  git clone https://gitee.com/mirrors/kubernetes.git
  git checkout v1.23.14
  ```

* 搞一个golang docker环境

  ```shell
  # systemctl start docker  如果没有启动, 就启动一下
  docker run -it -rm -v `pwd`:/go/src/ registry.cn-beijing.aliyuncs.com/dotbal/golang:kubeadn bash
  ```

* 开始进入容器编辑对应数据

  ```shell
  # 构建golang环境
  docker image pull golang:1.19.3
  docker run -it --rm -v `pwd`:/go/src/ golang:1.19.3 bash
  cd /go/src
  
  # 修改go代理, 资源下载会更快些
  go env -w GOPROXY=https://goproxy.cn,direct
  go env -w GOSUMDB=off
  
  # 修改源码
  grep "365" cmd/kubeadm/app/constants/constants.go
  sed -i 's/365/365 * 100/g' cmd/kubeadm/app/constants/constants.go
  grep "365" cmd/kubeadm/app/constants/constants.go
  
  mkdir -p _output/
  chmod 777 -R _output/
  make WHAT=cmd/kubeadm
  ```

  

```shell






/opt/kubeadm version
/opt/kubeadm certs renew all

kubeadm certs check-expiration

systemctl restart kubelet
```



# 4. 验证集群

* 查看全部Pod

  ```shell
  kubectl get pod --all-namespaces
  ```

* 查看metrics

  ```shell
  kubectl top po -n kube-system
  ```

* 查看svc网络

  ```shell
  kubectl get svc
  
  kubectl get svc -n kube-system
  # 查看dns是否正常, 在全集群中执行
  # 只用关心下面的命令正常就行, node中get svc是无法访问的
  telnet 10.0.0.1 443   
  telnet 10.0.0.10 53
  ```

  ![image-20221115185049943](.image/10-%E9%9B%86%E7%BE%A4%E4%BC%98%E5%8C%96/image-20221115185049943.png)

* 查看pod网络

  ```shell
  kubectl get po --all-namespaces -o wide
  # 在全集群中执行 查看ip是否连通
  ping 172.175.112.129 -c 4
  ```

* 查看service网络

  ```shell
  kubectl get po --all-namespaces -o wide
  # 随便找个Name进入容器测试
  kubectl exec -it calico-node-sk7fk   -n kube-system -- sh
  ping 172.175.112.129 -c 4  # mmp 没这个命令, 尴尬了.
  ```

  

