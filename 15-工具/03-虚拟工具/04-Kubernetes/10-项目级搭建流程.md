### 4.1.3 kubectl安装Calico

1. 下载资源

   ```shell
   链接：https://pan.baidu.com/s/1FhM8CHa3mILZfamLeA5nHQ 
   提取码：1111 
   
   cd /root/k8s-ha-install && git checkout manual-installation-v1.20.x && cd calico/
   ```

2. 修改master节点信息

   ```shell
   sed -i 's#etcd_endpoints: "http://<ETCD_IP>:<ETCD_PORT>"#etcd_endpoints: "https://10.111.0.10:2379,https://10.111.0.12:2379"#g' calico-etcd.yaml
   
   # vim calico-etcd.yaml  修改内容信息:
   # etcd_endpoints: "https://10.111.0.10:2379,https://10.111.0.12:2379"
   ```

3. 修改etcd证书位置

   ```shell
   ETCD_CA=`cat /etc/kubernetes/pki/etcd/ca.crt | base64 | tr -d '\n'`
   ETCD_CERT=`cat /etc/kubernetes/pki/etcd/server.crt | base64 | tr -d '\n'`
   ETCD_KEY=`cat /etc/kubernetes/pki/etcd/server.key | base64 | tr -d '\n'`
   sed -i "s@# etcd-key: null@etcd-key: ${ETCD_KEY}@g; s@# etcd-cert: null@etcd-cert: ${ETCD_CERT}@g; s@# etcd-ca: null@etcd-ca: ${ETCD_CA}@g" calico-etcd.yaml
   ```

4. 修改pod证书位置

   ```shell
   sed -i 's#etcd_ca: ""#etcd_ca: "/calico-secrets/etcd-ca"#g; s#etcd_cert: ""#etcd_cert: "/calico-secrets/etcd-cert"#g; s#etcd_key: "" #etcd_key: "/calico-secrets/etcd-key" #g' calico-etcd.yaml
   ```

5. 修改pod网段

   ```shell
   POD_SUBNET=`cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr= | awk -F= '{print $NF}'`
   
   # 检查一下
   # 搜索CALICO_IPV4POOL_CIDR, 解开注释, 并设置为pod的网段
   -name: CALICO_IPV4POOL_CIDR
    value: "172.168.0.0/16"
   ```

6. 安装

   ```shell
   kubectl apply -f calico-etcd.yaml
   ```

### 4.1.4 kubectl安装metrics

1. 将证书发往其他节点

   ```shell
   for i in master02 master03 ;do scp /etc/kubernetes/pki/front-proxy-ca.crt $i:/etc/kubernetes/pki/front-proxy-ca.crt ; done
   ```

2. 安装metrics

   ```shell
   cd /root/k8s-ha-install/metrics-server-0.4.x-kubeadm/
   
   kubectl  create -f comp.yaml
   ```

3. 查看状态

   ```shell
   kubectl get pods -n kube-system -o wide  # 等待metrics-server状态变为running
   kubectl  top node
   ```

### 4.1.5 安装DashBoard

1. 安装dashboard

   ```shell
   cd /root/k8s-ha-install/dashboard
   kubectl  create -f .
   ```

2. 配置浏览器

   ```shell
   # 在路径中添加: --test-type --ignore-certificate-errors
   ```

3. 修改svc为转发端口

   ```shell
   kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
   # 修改type为NodePort
   ```

4. 查看dashboard暴露的端口

   ```shell
   kubectl get svc kubernetes-dashboard -n kubernetes-dashboard
   ```

5. 访问页面

   ```shell
   https://10.111.0.111:31755  # ip为vip
   ```

6. 登录token获取

   ```shell
   kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')
   ```

### 4.1.6 将HA应用到集群

1. 查看当前模式

   ```shell
   curl 127.0.0.1:10249/proxyMode
   ```

2. 修改配置

   ```shell
   kubectl edit cm kube-proxy -n kube-system
   修改信息 mode: "ipvs"
   ```

3. 更新pod

   ```shell
   kubectl patch daemonset kube-proxy -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"date\":\"`date +'%s'`\"}}}}}" -n kube-system
   ```

4. 重新检查pod

   ```shell
   curl 127.0.0.1:10249/proxyMode
   ```

### 4.1.7 移除污点

默认k8s不允许非系统自带服务安装到master节点中, 所以想要在master中安装三方服务, 需要取消污点

1. 查看污点

   ```shell
   kubectl  describe node -l node-role.kubernetes.io/master=  | grep Taints
   ```

2. 删除污点

   ```shell
   kubectl  taint node  -l node-role.kubernetes.io/master node-role.kubernetes.io/master:NoSchedule-
   ```
